<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste do Sistema de Autenticação - Pet Shop Baronesa</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }
        
        .test-section h2 {
            color: #007bff;
            margin-bottom: 1rem;
        }
        
        .test-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .test-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .test-button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .test-button.primary {
            background: #007bff;
            color: white;
        }
        
        .test-button.secondary {
            background: #6c757d;
            color: white;
        }
        
        .test-button.success {
            background: #28a745;
            color: white;
        }
        
        .test-button.danger {
            background: #dc3545;
            color: white;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .test-result {
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }
        
        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }
        
        .status-authenticated {
            background: #d4edda;
            color: #155724;
        }
        
        .status-guest {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-admin {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-user {
            background: #cce5ff;
            color: #004085;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
        
        .loading i {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1><i class="fas fa-shield-alt"></i> Teste do Sistema de Autenticação</h1>
        <p>Esta página permite testar todas as funcionalidades do sistema de autenticação baseado em banco de dados.</p>
        
        <!-- Status atual -->
        <div class="test-section">
            <h2><i class="fas fa-info-circle"></i> Status Atual</h2>
            <div class="test-info">
                <p><strong>Estado de Autenticação:</strong> <span id="authStatus" class="status-indicator">Carregando...</span></p>
                <p><strong>Tipo de Usuário:</strong> <span id="userType" class="status-indicator">Carregando...</span></p>
                <p><strong>Usuário Atual:</strong> <span id="currentUser">Carregando...</span></p>
                <p><strong>Sistema Inicializado:</strong> <span id="systemStatus">Carregando...</span></p>
            </div>
            <div class="test-buttons">
                <button class="test-button primary" onclick="refreshStatus()">
                    <i class="fas fa-sync"></i> Atualizar Status
                </button>
                <button class="test-button secondary" onclick="showSystemInfo()">
                    <i class="fas fa-info"></i> Informações do Sistema
                </button>
            </div>
            <div id="statusResult" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Testes de Autenticação -->
        <div class="test-section">
            <h2><i class="fas fa-user-check"></i> Testes de Autenticação</h2>
            <div class="test-info">
                <p>Teste as funções básicas de autenticação:</p>
            </div>
            <div class="test-buttons">
                <button class="test-button primary" onclick="testIsAuthenticated()">
                    <i class="fas fa-check-circle"></i> Verificar se Está Autenticado
                </button>
                <button class="test-button secondary" onclick="testGetCurrentUser()">
                    <i class="fas fa-user"></i> Obter Usuário Atual
                </button>
                <button class="test-button success" onclick="testGetUserType()">
                    <i class="fas fa-tag"></i> Verificar Tipo de Usuário
                </button>
            </div>
            <div id="authResult" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Testes de Permissões -->
        <div class="test-section">
            <h2><i class="fas fa-shield-alt"></i> Testes de Permissões</h2>
            <div class="test-info">
                <p>Teste as verificações de permissões:</p>
            </div>
            <div class="test-buttons">
                <button class="test-button primary" onclick="testIsAdmin()">
                    <i class="fas fa-crown"></i> Verificar se é Admin
                </button>
                <button class="test-button secondary" onclick="testIsUser()">
                    <i class="fas fa-user"></i> Verificar se é Usuário
                </button>
                <button class="test-button success" onclick="testAllPermissions()">
                    <i class="fas fa-list-check"></i> Testar Todas as Permissões
                </button>
            </div>
            <div id="permissionResult" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Testes do Sistema de Cache -->
        <div class="test-section">
            <h2><i class="fas fa-database"></i> Testes do Sistema de Cache</h2>
            <div class="test-info">
                <p>Teste o sistema de cache de tipos de usuário:</p>
            </div>
            <div class="test-buttons">
                <button class="test-button primary" onclick="testCacheSystem()">
                    <i class="fas fa-memory"></i> Testar Cache
                </button>
                <button class="test-button danger" onclick="clearCache()">
                    <i class="fas fa-trash"></i> Limpar Cache
                </button>
                <button class="test-button secondary" onclick="testCachePerformance()">
                    <i class="fas fa-stopwatch"></i> Testar Performance
                </button>
            </div>
            <div id="cacheResult" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Testes de Middleware -->
        <div class="test-section">
            <h2><i class="fas fa-lock"></i> Testes de Middleware</h2>
            <div class="test-info">
                <p>Teste o middleware de proteção de páginas:</p>
            </div>
            <div class="test-buttons">
                <button class="test-button primary" onclick="testAdminProtection()">
                    <i class="fas fa-shield-alt"></i> Testar Proteção Admin
                </button>
                <button class="test-button secondary" onclick="testPageRedirection()">
                    <i class="fas fa-external-link-alt"></i> Testar Redirecionamento
                </button>
                <button class="test-button success" onclick="testMiddlewareInit()">
                    <i class="fas fa-cogs"></i> Testar Inicialização
                </button>
            </div>
            <div id="middlewareResult" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Testes de Gerenciamento de Usuários -->
        <div class="test-section">
            <h2><i class="fas fa-users-cog"></i> Testes de Gerenciamento de Usuários</h2>
            <div class="test-info">
                <p>Teste as funções de gerenciamento de usuários (apenas para admins):</p>
            </div>
            <div class="test-buttons">
                <button class="test-button primary" onclick="testUserManagement()">
                    <i class="fas fa-users"></i> Testar Gerenciamento
                </button>
                <button class="test-button secondary" onclick="testUserTypeUpdate()">
                    <i class="fas fa-user-edit"></i> Testar Atualização de Tipo
                </button>
                <button class="test-button success" onclick="testUserListing()">
                    <i class="fas fa-list"></i> Testar Listagem
                </button>
            </div>
            <div id="userMgmtResult" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Testes de Integração -->
        <div class="test-section">
            <h2><i class="fas fa-plug"></i> Testes de Integração</h2>
            <div class="test-info">
                <p>Teste a integração com outros sistemas:</p>
            </div>
            <div class="test-buttons">
                <button class="test-button primary" onclick="testFooterIntegration()">
                    <i class="fas fa-link"></i> Testar Footer
                </button>
                <button class="test-button secondary" onclick="testIndexIntegration()">
                    <i class="fas fa-home"></i> Testar Index
                </button>
                <button class="test-button success" onclick="testAllIntegrations()">
                    <i class="fas fa-network-wired"></i> Testar Todas as Integrações
                </button>
            </div>
            <div id="integrationResult" class="test-result" style="display: none;"></div>
        </div>
        
        <!-- Ações Rápidas -->
        <div class="test-section">
            <h2><i class="fas fa-bolt"></i> Ações Rápidas</h2>
            <div class="test-info">
                <p>Ações rápidas para testes:</p>
            </div>
            <div class="test-buttons">
                <button class="test-button success" onclick="runAllTests()">
                    <i class="fas fa-play"></i> Executar Todos os Testes
                </button>
                <button class="test-button danger" onclick="resetSystem()">
                    <i class="fas fa-power-off"></i> Resetar Sistema
                </button>
                <button class="test-button primary" onclick="simulateLogin()">
                    <i class="fas fa-sign-in-alt"></i> Simular Login
                </button>
                <button class="test-button secondary" onclick="simulateLogout()">
                    <i class="fas fa-sign-out-alt"></i> Simular Logout
                </button>
            </div>
            <div id="quickResult" class="test-result" style="display: none;"></div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Sistema de Autenticação -->
    <script src="js/path-config.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/admin-middleware.js"></script>
    <script src="js/user-management.js"></script>
    <script src="js/footer-permissions.js"></script>
    <script src="js/index-permissions.js"></script>
    
    <script>
        // Sistema de Testes
        class AuthTester {
            constructor() {
                this.results = {};
                this.init();
            }
            
            async init() {
                try {
                    // Aguardar inicialização do sistema
                    await this.waitForSystems();
                    await this.refreshStatus();
                    console.log('Sistema de testes inicializado');
                } catch (error) {
                    console.error('Erro ao inicializar sistema de testes:', error);
                }
            }
            
            async waitForSystems() {
                let retries = 0;
                const maxRetries = 100;
                
                while (retries < maxRetries) {
                    if (typeof window.auth !== 'undefined' && 
                        typeof window.adminMiddleware !== 'undefined' && 
                        typeof window.footerPermissionManager !== 'undefined') {
                        return;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }
                
                throw new Error('Timeout aguardando sistemas');
            }
            
            showResult(elementId, result, type = 'info') {
                const element = document.getElementById(elementId);
                if (element) {
                    element.innerHTML = result;
                    element.className = `test-result ${type}`;
                    element.style.display = 'block';
                }
            }
            
            async refreshStatus() {
                try {
                    const isAuth = window.auth?.isAuthenticated() || false;
                    const userType = await window.auth?.getCurrentUserType() || 'guest';
                    const currentUser = window.auth?.getCurrentUser();
                    
                    document.getElementById('authStatus').textContent = isAuth ? 'Autenticado' : 'Não Autenticado';
                    document.getElementById('authStatus').className = `status-indicator ${isAuth ? 'status-authenticated' : 'status-guest'}`;
                    
                    document.getElementById('userType').textContent = userType === 'admin' ? 'Administrador' : userType === 'user' ? 'Usuário' : 'Visitante';
                    document.getElementById('userType').className = `status-indicator status-${userType}`;
                    
                    document.getElementById('currentUser').textContent = currentUser ? 
                        (currentUser.displayName || currentUser.email || 'Usuário') : 'Nenhum';
                    
                    document.getElementById('systemStatus').textContent = 'Inicializado';
                    document.getElementById('systemStatus').className = 'status-indicator status-authenticated';
                    
                } catch (error) {
                    console.error('Erro ao atualizar status:', error);
                }
            }
        }
        
        // Instanciar o sistema de testes
        const authTester = new AuthTester();
        
        // Funções de teste
        async function refreshStatus() {
            await authTester.refreshStatus();
            authTester.showResult('statusResult', 'Status atualizado com sucesso!', 'success');
        }
        
        async function showSystemInfo() {
            const info = {
                'Sistema Auth': typeof window.auth !== 'undefined' ? 'Carregado' : 'Não carregado',
                'Admin Middleware': typeof window.adminMiddleware !== 'undefined' ? 'Carregado' : 'Não carregado',
                'Footer Permissions': typeof window.footerPermissionManager !== 'undefined' ? 'Carregado' : 'Não carregado',
                'Index Permissions': typeof window.indexPermissionManager !== 'undefined' ? 'Carregado' : 'Não carregado',
                'User Management': typeof window.userManagement !== 'undefined' ? 'Carregado' : 'Não carregado',
                'Firebase': typeof window.firebase !== 'undefined' ? 'Carregado' : 'Não carregado'
            };
            
            let result = 'Informações do Sistema:\n\n';
            for (const [key, value] of Object.entries(info)) {
                result += `${key}: ${value}\n`;
            }
            
            authTester.showResult('statusResult', result, 'info');
        }
        
        async function testIsAuthenticated() {
            try {
                const result = window.auth?.isAuthenticated() || false;
                authTester.showResult('authResult', 
                    `Resultado: ${result ? 'Usuário está autenticado' : 'Usuário não está autenticado'}`, 
                    result ? 'success' : 'error');
            } catch (error) {
                authTester.showResult('authResult', `Erro: ${error.message}`, 'error');
            }
        }
        
        async function testGetCurrentUser() {
            try {
                const user = window.auth?.getCurrentUser();
                const result = user ? 
                    `Usuário: ${user.displayName || user.email || 'Sem nome'}\nUID: ${user.uid}` :
                    'Nenhum usuário autenticado';
                authTester.showResult('authResult', result, user ? 'success' : 'error');
            } catch (error) {
                authTester.showResult('authResult', `Erro: ${error.message}`, 'error');
            }
        }
        
        async function testGetUserType() {
            try {
                const userType = await window.auth?.getCurrentUserType() || 'guest';
                authTester.showResult('authResult', `Tipo de usuário: ${userType}`, 'info');
            } catch (error) {
                authTester.showResult('authResult', `Erro: ${error.message}`, 'error');
            }
        }
        
        async function testIsAdmin() {
            try {
                const isAdmin = await window.auth?.isAdmin() || false;
                authTester.showResult('permissionResult', 
                    `Resultado: ${isAdmin ? 'Usuário é administrador' : 'Usuário não é administrador'}`, 
                    isAdmin ? 'success' : 'error');
            } catch (error) {
                authTester.showResult('permissionResult', `Erro: ${error.message}`, 'error');
            }
        }
        
        async function testIsUser() {
            try {
                const isUser = await window.auth?.isUser() || false;
                authTester.showResult('permissionResult', 
                    `Resultado: ${isUser ? 'Usuário é user comum' : 'Usuário não é user comum'}`, 
                    isUser ? 'success' : 'error');
            } catch (error) {
                authTester.showResult('permissionResult', `Erro: ${error.message}`, 'error');
            }
        }
        
        async function testAllPermissions() {
            try {
                const isAuth = window.auth?.isAuthenticated() || false;
                const isAdmin = await window.auth?.isAdmin() || false;
                const isUser = await window.auth?.isUser() || false;
                const userType = await window.auth?.getCurrentUserType() || 'guest';
                
                let result = 'Teste de Permissões:\n\n';
                result += `Autenticado: ${isAuth ? 'Sim' : 'Não'}\n`;
                result += `É Admin: ${isAdmin ? 'Sim' : 'Não'}\n`;
                result += `É User: ${isUser ? 'Sim' : 'Não'}\n`;
                result += `Tipo: ${userType}\n`;
                
                authTester.showResult('permissionResult', result, 'info');
            } catch (error) {
                authTester.showResult('permissionResult', `Erro: ${error.message}`, 'error');
            }
        }
        
        async function testCacheSystem() {
            try {
                const currentUser = window.auth?.getCurrentUser();
                if (!currentUser) {
                    authTester.showResult('cacheResult', 'Usuário não autenticado - não é possível testar cache', 'error');
                    return;
                }
                
                const startTime = Date.now();
                const userType1 = await window.auth?.checkUserType(currentUser.uid);
                const time1 = Date.now() - startTime;
                
                const startTime2 = Date.now();
                const userType2 = await window.auth?.checkUserType(currentUser.uid);
                const time2 = Date.now() - startTime2;
                
                let result = 'Teste de Cache:\n\n';
                result += `Primeira consulta: ${userType1} (${time1}ms)\n`;
                result += `Segunda consulta: ${userType2} (${time2}ms)\n`;
                result += `Cache funcionando: ${time2 < time1 ? 'Sim' : 'Não'}\n`;
                
                authTester.showResult('cacheResult', result, 'success');
            } catch (error) {
                authTester.showResult('cacheResult', `Erro: ${error.message}`, 'error');
            }
        }
        
        async function clearCache() {
            try {
                window.auth?.clearUserTypeCache();
                authTester.showResult('cacheResult', 'Cache limpo com sucesso!', 'success');
            } catch (error) {
                authTester.showResult('cacheResult', `Erro: ${error.message}`, 'error');
            }
        }
        
        async function testCachePerformance() {
            try {
                const currentUser = window.auth?.getCurrentUser();
                if (!currentUser) {
                    authTester.showResult('cacheResult', 'Usuário não autenticado - não é possível testar performance', 'error');
                    return;
                }
                
                // Limpar cache primeiro
                window.auth?.clearUserTypeCache();
                
                // Teste sem cache
                const startTime1 = Date.now();
                await window.auth?.checkUserType(currentUser.uid);
                const timeWithoutCache = Date.now() - startTime1;
                
                // Teste com cache
                const startTime2 = Date.now();
                await window.auth?.checkUserType(currentUser.uid);
                const timeWithCache = Date.now() - startTime2;
                
                const improvement = ((timeWithoutCache - timeWithCache) / timeWithoutCache * 100).toFixed(2);
                
                let result = 'Teste de Performance:\n\n';
                result += `Sem cache: ${timeWithoutCache}ms\n`;
                result += `Com cache: ${timeWithCache}ms\n`;
                result += `Melhoria: ${improvement}%\n`;
                
                authTester.showResult('cacheResult', result, 'success');
            } catch (error) {
                authTester.showResult('cacheResult', `Erro: ${error.message}`, 'error');
            }
        }
        
        // Adicionar outras funções de teste...
        async function testAdminProtection() {
            try {
                const hasAccess = await window.adminMiddleware?.hasAdminAccess() || false;
                authTester.showResult('middlewareResult', 
                    `Acesso admin: ${hasAccess ? 'Permitido' : 'Negado'}`, 
                    hasAccess ? 'success' : 'error');
            } catch (error) {
                authTester.showResult('middlewareResult', `Erro: ${error.message}`, 'error');
            }
        }
        
        async function runAllTests() {
            authTester.showResult('quickResult', 'Executando todos os testes...', 'info');
            
            try {
                await testIsAuthenticated();
                await new Promise(resolve => setTimeout(resolve, 500));
                await testGetUserType();
                await new Promise(resolve => setTimeout(resolve, 500));
                await testAllPermissions();
                await new Promise(resolve => setTimeout(resolve, 500));
                await testCacheSystem();
                await new Promise(resolve => setTimeout(resolve, 500));
                await testAdminProtection();
                
                authTester.showResult('quickResult', 'Todos os testes executados com sucesso!', 'success');
            } catch (error) {
                authTester.showResult('quickResult', `Erro durante os testes: ${error.message}`, 'error');
            }
        }
        
        // Placeholder para outras funções de teste
        async function testPageRedirection() {
            authTester.showResult('middlewareResult', 'Teste de redirecionamento ainda não implementado', 'info');
        }
        
        async function testMiddlewareInit() {
            const initialized = window.adminMiddleware?.isInitialized || false;
            authTester.showResult('middlewareResult', `Middleware inicializado: ${initialized}`, initialized ? 'success' : 'error');
        }
        
        async function testUserManagement() {
            const available = typeof window.userManagement !== 'undefined';
            authTester.showResult('userMgmtResult', `Gerenciamento de usuários: ${available ? 'Disponível' : 'Não disponível'}`, available ? 'success' : 'error');
        }
        
        async function testUserTypeUpdate() {
            authTester.showResult('userMgmtResult', 'Teste de atualização de tipo de usuário requer implementação específica', 'info');
        }
        
        async function testUserListing() {
            authTester.showResult('userMgmtResult', 'Teste de listagem de usuários requer implementação específica', 'info');
        }
        
        async function testFooterIntegration() {
            const available = typeof window.footerPermissionManager !== 'undefined';
            authTester.showResult('integrationResult', `Footer permissions: ${available ? 'Disponível' : 'Não disponível'}`, available ? 'success' : 'error');
        }
        
        async function testIndexIntegration() {
            const available = typeof window.indexPermissionManager !== 'undefined';
            authTester.showResult('integrationResult', `Index permissions: ${available ? 'Disponível' : 'Não disponível'}`, available ? 'success' : 'error');
        }
        
        async function testAllIntegrations() {
            const footer = typeof window.footerPermissionManager !== 'undefined';
            const index = typeof window.indexPermissionManager !== 'undefined';
            const admin = typeof window.adminMiddleware !== 'undefined';
            const userMgmt = typeof window.userManagement !== 'undefined';
            
            let result = 'Integrações:\n\n';
            result += `Footer: ${footer ? 'OK' : 'Falha'}\n`;
            result += `Index: ${index ? 'OK' : 'Falha'}\n`;
            result += `Admin: ${admin ? 'OK' : 'Falha'}\n`;
            result += `User Mgmt: ${userMgmt ? 'OK' : 'Falha'}\n`;
            
            authTester.showResult('integrationResult', result, 'info');
        }
        
        async function resetSystem() {
            try {
                window.auth?.clearUserTypeCache();
                localStorage.removeItem('petshop_baronesa_auth');
                authTester.showResult('quickResult', 'Sistema resetado com sucesso!', 'success');
                await refreshStatus();
            } catch (error) {
                authTester.showResult('quickResult', `Erro: ${error.message}`, 'error');
            }
        }
        
        async function simulateLogin() {
            authTester.showResult('quickResult', 'Simulação de login requer implementação específica', 'info');
        }
        
        async function simulateLogout() {
            try {
                await window.auth?.logout();
                authTester.showResult('quickResult', 'Logout simulado com sucesso!', 'success');
                await refreshStatus();
            } catch (error) {
                authTester.showResult('quickResult', `Erro: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
